name: Gestion Automatique des Issues

on:
  issues:
    types: [opened, labeled]

jobs:
  auto-assign:
    name: Attribution Automatique
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: Auto-assign selon les labels
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(label => label.name);
            
            // Attribution automatique selon le type
            let assignees = [];
            
            if (labels.includes('security')) {
              // Assigner les issues de s√©curit√© au lead technique
              assignees.push('lead-dev-username');
            } else if (labels.includes('bug') && labels.includes('P0-critical')) {
              // Assigner les bugs critiques imm√©diatement
              assignees.push('lead-dev-username');
            } else if (labels.includes('enhancement')) {
              // Assigner les demandes de fonctionnalit√©s au product owner
              assignees.push('product-owner-username');
            }
            
            if (assignees.length > 0) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: assignees
              });
            }

  auto-label:
    name: √âtiquetage Automatique
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: Auto-label bas√© sur le contenu
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body.toLowerCase();
            
            let labelsToAdd = [];
            
            // D√©tection automatique de module
            if (title.includes('auth') || body.includes('authentification') || body.includes('login')) {
              labelsToAdd.push('module:auth');
            }
            if (title.includes('emotion') || body.includes('tracker')) {
              labelsToAdd.push('module:emotions');
            }
            if (title.includes('diagnostic')) {
              labelsToAdd.push('module:diagnostics');
            }
            if (title.includes('activit') || body.includes('d√©tente')) {
              labelsToAdd.push('module:activities');
            }
            
            // D√©tection de type
            if (title.includes('[bug]') || title.includes('erreur') || title.includes('probl√®me')) {
              labelsToAdd.push('bug');
            }
            if (title.includes('[feature]') || title.includes('fonctionnalit√©') || title.includes('am√©lioration')) {
              labelsToAdd.push('enhancement');
            }
            if (title.includes('[security]') || body.includes('s√©curit√©') || body.includes('vuln√©rabilit√©')) {
              labelsToAdd.push('security');
              labelsToAdd.push('urgent');
            }
            
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labelsToAdd
              });
            }

  security-alert:
    name: Alerte S√©curit√©
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'security')

    steps:
      - name: Notification urgente s√©curit√©
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            
            // Cr√©er un commentaire urgent
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `üö® **ALERTE S√âCURIT√â D√âTECT√âE**
            
              Cette issue a √©t√© automatiquement marqu√©e comme probl√®me de s√©curit√©.
            
              **Actions automatiques prises :**
              - üè∑Ô∏è √âtiquet√©e comme "security" et "urgent"
              - üë• √âquipe s√©curit√© notifi√©e
              - ‚è∞ SLA r√©duit √† 2 heures
            
              **Prochaines √©tapes :**
              1. √âvaluation imm√©diate de la criticit√©
              2. Analyse d'impact sur les donn√©es utilisateur
              3. Plan de correction si n√©cessaire
            
              L'√©quipe technique va traiter cette issue en priorit√©.`
            });